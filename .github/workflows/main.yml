name: Spring Boot CI/CD with Trivy

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 21

      # 3Ô∏è‚É£ Build Spring Boot JAR
      - name: Build application
        run: |
          mvn clean
          mvn -B package --file pom.xml

      # 4Ô∏è‚É£ Login Docker Hub
      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 5Ô∏è‚É£ Build Docker image locally
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:1.0.0

      # 6Ô∏è‚É£ Run Trivy vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:1.0.0
          format: json
          exit-code: '0'
          ignore-unfixed: true
          output: trivy.json
          severity: HIGH,CRITICAL

      # 7Ô∏è‚É£ Detect HIGH/CRITICAL vulnerabilities (simple grep)
      - name: Detect HIGH/CRITICAL vulnerabilities (method 1)
        id: detect_grep
        run: |
          if grep -q '"Severity":"HIGH"' trivy.json || grep -q '"Severity":"CRITICAL"' trivy.json; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 8Ô∏è‚É£ Detect HIGH/CRITICAL vulnerabilities (jq method)
      - name: Detect HIGH/CRITICAL vulnerabilities (method 2)
        id: detect
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          has_vuln=$(jq '[.. | .Severity?] | map(select(.=="HIGH" or .=="CRITICAL")) | length > 0' trivy.json)

          if [ "$has_vuln" = "true" ]; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 9Ô∏è‚É£ Install Trivy (required for trivy image ...)
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      # üîü Pull latest image if vulnerabilities exist
      - name: Pull latest image
        if: steps.detect.outputs.has_vuln == 'true'
        run: |
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Rescan pulled image
      - name: Rescan pulled image
        if: steps.detect.outputs.has_vuln == 'true'
        id: trivy_rescan
        run: |
          trivy image --format json --output trivy-rescan.json \
            --severity HIGH,CRITICAL \
            ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£2Ô∏è‚É£ Detect if rescan image is clean
      - name: Detect rescan clean result
        if: steps.detect.outputs.has_vuln == 'true'
        id: detect_rescan
        run: |
          if ! grep -q '"Severity":"HIGH"' trivy-rescan.json && ! grep -q '"Severity":"CRITICAL"' trivy-rescan.json; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£3Ô∏è‚É£ Push image only if clean after rescan
      - name: Push clean image
        if: steps.detect_rescan.outputs.clean == 'true'
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£4Ô∏è‚É£ Push image normally if no vulnerabilities initially
      - name: Push image (no vulnerabilities)
        if: steps.detect.outputs.has_vuln != 'true'
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
