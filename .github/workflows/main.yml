name: Spring Boot CI/CD with Trivy

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 21

      # 3Ô∏è‚É£ Build JAR
      - name: Build application
        run: |
          mvn clean
          mvn -B package --file pom.xml

      # 4Ô∏è‚É£ Build Docker image locally
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 5Ô∏è‚É£ Scan image with Trivy (JSON)
      - name: Scan Docker image with Trivy
        id: trivy_scan
        run: |
          trivy image --format json --output trivy.json \
            --severity HIGH,CRITICAL \
            ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 6Ô∏è‚É£ Detect HIGH or CRITICAL using grep
      - name: Detect HIGH/CRITICAL
        id: detect
        run: |
          if grep -q '"Severity":"HIGH"' trivy.json || grep -q '"Severity":"CRITICAL"' trivy.json; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ Login to Docker Hub if vulnerabilities
      - name: Docker Hub login
        if: steps.detect.outputs.has_vuln == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 8Ô∏è‚É£ Pull latest image
      - name: Pull latest image
        if: steps.detect.outputs.has_vuln == 'true'
        run: |
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 9Ô∏è‚É£ Rescan pulled image
      - name: Rescan pulled image
        if: steps.detect.outputs.has_vuln == 'true'
        id: trivy_rescan
        run: |
          trivy image --format json --output trivy-rescan.json \
            --severity HIGH,CRITICAL \
            ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # üîü Detect if image is now clean
      - name: Detect rescan result
        if: steps.detect.outputs.has_vuln == 'true'
        id: detect_rescan
        run: |
          if ! grep -q '"Severity":"HIGH"' trivy-rescan.json && ! grep -q '"Severity":"CRITICAL"' trivy-rescan.json; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT

      # 1Ô∏è‚É£1Ô∏è‚É£ Push image only if clean after rescan
      - name: Push clean image
        if: steps.detect_rescan.outputs.clean == 'true'
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
