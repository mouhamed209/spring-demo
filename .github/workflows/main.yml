name: Spring Boot CI/CD with Trivy and Grep

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 21

      # 3Ô∏è‚É£ Build JAR
      - name: Build application
        run: |
          mvn -B clean package

      # 4Ô∏è‚É£ Build LOCAL Docker image
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:${{ github.sha }} .

      # 5Ô∏è‚É£ Run Trivy using GitHub Action (scan local image)
      - name: Run Trivy vulnerability scanner
        id: trivy_scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:${{ github.sha }}'
          format: 'json'
          output: 'trivy.json'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # ‚ö† we continue even if vulnerabilities exist!

      # 6Ô∏è‚É£ Check vulnerabilities using grep
      - name: Detect HIGH/CRITICAL vulnerabilities
        id: detect_local
        run: |
          if grep -q '"Severity":"HIGH"' trivy.json || grep -q '"Severity":"CRITICAL"' trivy.json; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ Login to Docker Hub if vulnerabilities exist
      - name: Docker Hub login
        if: steps.detect_local.outputs.has_vuln == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 8Ô∏è‚É£ Pull latest Docker Hub image
      - name: Pull latest Docker Hub image
        if: steps.detect_local.outputs.has_vuln == 'true'
        run: |
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest || echo "No latest image found"

      # 9Ô∏è‚É£ Rescan pulled image (Trivy Action)
      - name: Rescan pulled image
        if: steps.detect_local.outputs.has_vuln == 'true'
        id: trivy_rescan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest'
          format: 'json'
          output: 'trivy-rescan.json'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      # üîü Check if pulled image is clean
      - name: Detect vulnerabilities in rescan
        if: steps.detect_local.outputs.has_vuln == 'true'
        id: detect_rescan
        run: |
          if ! grep -q '"Severity":"HIGH"' trivy-rescan.json && ! grep -q '"Severity":"CRITICAL"' trivy-rescan.json; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Push new image only if pulled version is clean
      - name: Push new clean image
        if: steps.detect_rescan.outputs.clean == 'true'
        run: |
          docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:${{ github.sha }} \
                     ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£2Ô∏è‚É£ Push normally if NO vulnerabilities found originally
      - name: Push image (no vulnerabilities)
        if: steps.detect_local.outputs.has_vuln != 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
