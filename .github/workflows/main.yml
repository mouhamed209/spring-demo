name: spring boot demo

on: 
  push:
    branches:
      - main

jobs:
  build-deploy:
    name: Build and Deploy Spring Boot Beginners
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code 
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 21

      # 3Ô∏è‚É£ Build JAR
      - name: Build application
        run: |
          mvn clean
          mvn -B package --file pom.xml

      # 4Ô∏è‚É£ Build Docker image locally
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 5Ô∏è‚É£ Scan image with Trivy (JSON)
      - name: Scan image with Trivy (JSON)
        id: trivy_json
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
          format: 'json'
          output: trivy.json
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

      # 6Ô∏è‚É£ Detect HIGH/CRITICAL
      - name: Detect HIGH/CRITICAL via bash
        id: detect
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          HIGH=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="HIGH")] | length' trivy.json 2>/dev/null || echo 0)
          CRITICAL=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' trivy.json 2>/dev/null || echo 0)
          if [ "$HIGH" -gt 0 ] || [ "$CRITICAL" -gt 0 ]; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ ÿ•ÿ∞ÿß ŸÅŸäŸá Vulnerabilities ‚Üí ŸÜÿ≥ÿ≠ÿ® ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ŸÖŸÜ Docker Hub ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑŸÅÿ≠ÿµ
      - name: Docker Hub Login
        if: steps.detect.outputs.has_vuln == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Pull latest image from Docker Hub
        if: steps.detect.outputs.has_vuln == 'true'
        run: docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 8Ô∏è‚É£ Rescan pulled image
      - name: Rescan pulled image with Trivy
        if: steps.detect.outputs.has_vuln == 'true'
        id: trivy_rescan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
          format: 'json'
          output: trivy-rescan.json
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

      # 9Ô∏è‚É£ Detect if image is now clean
      - name: Detect rescan result
        if: steps.detect.outputs.has_vuln == 'true'
        id: detect_rescan
        shell: bash
        run: |
          HIGH=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="HIGH")] | length' trivy-rescan.json 2>/dev/null || echo 0)
          CRITICAL=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' trivy-rescan.json 2>/dev/null || echo 0)
          if [ "$HIGH" -eq 0 ] && [ "$CRITICAL" -eq 0 ]; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT

      # üîü Push image only if clean after pull+rescan
      - name: Push cleaned image to Docker Hub
        if: steps.detect.outputs.has_vuln == 'true' && steps.detect_rescan.outputs.clean == 'true'
        run: docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ If no vulnerabilities from the beginning ‚Üí push normally
      - name: Final Login (no vuln case)
        if: steps.detect.outputs.has_vuln != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Final push (image is clean)
        if: steps.detect.outputs.has_vuln != 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
