name: Spring Boot CI/CD with Trivy + Conditional Push

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 21

      # 3Ô∏è‚É£ Build Spring Boot JAR
      - name: Build application
        run: |
          mvn clean
          mvn -B package --file pom.xml

      # 4Ô∏è‚É£ Login Docker Hub
      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 5Ô∏è‚É£ Build Docker image locally
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: my-organization/spring-boot:latest

      # 6Ô∏è‚É£ Run Trivy scan locally
      - name: Scan local Docker image
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.41.0 image \
          --format json --output trivy.json \
          --severity HIGH,CRITICAL \
          my-organization/spring-boot:latest

      # 7Ô∏è‚É£ Detect HIGH/CRITICAL using grep
      - name: Detect vulnerabilities
        id: detect
        run: |
          if grep -q '"Severity":"HIGH"' trivy.json || grep -q '"Severity":"CRITICAL"' trivy.json; then
            echo "has_vuln=true" >> $GITHUB_OUTPUT
          else
            echo "has_vuln=false" >> $GITHUB_OUTPUT
          fi

      # 8Ô∏è‚É£ Pull latest image from Docker Hub if local image has vulnerabilities
      - name: Pull latest Docker Hub image
        if: steps.detect.outputs.has_vuln == 'true'
        run: |
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 9Ô∏è‚É£ Rescan pulled image
      - name: Rescan pulled image
        if: steps.detect.outputs.has_vuln == 'true'
        id: rescan
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.41.0 image \
          --format json --output trivy-rescan.json \
          --severity HIGH,CRITICAL \
          ${{ secrets.DOCKER_HUB_USERNAME }}/my-app:latest
          
          if ! grep -q '"Severity":"HIGH"' trivy-rescan.json && ! grep -q '"Severity":"CRITICAL"' trivy-rescan.json; then
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      # üîü Push new image only if latest image from Docker Hub is clean
      - name: Push updated image
        if: steps.rescan.outputs.clean == 'true'
        run: |
          docker tag my-organization/spring-boot:latest ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Push image normally if no vulnerabilities locally
      - name: Push image (no vulnerabilities)
        if: steps.detect.outputs.has_vuln != 'true'
        run: |
          docker tag my-organization/spring-boot:latest ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/spring-boot:latest
